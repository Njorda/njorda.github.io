<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>ShareIt, a cli for sharing files - Njord tech blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="TLDR: code can be found here.
In this blog post we will dive down in to how to build a small CLI for sharing files. The goal is to go over how to build a go cli for sharing files. We will set it up so that a shareable link will be created with a set expiration time and the object will be cleaned up after twice that time. For a file we will do the following:"><meta property="og:image" content><meta property="og:title" content="ShareIt, a cli for sharing files"><meta property="og:description" content="TLDR: code can be found here.
In this blog post we will dive down in to how to build a small CLI for sharing files. The goal is to go over how to build a go cli for sharing files. We will set it up so that a shareable link will be created with a set expiration time and the object will be cleaned up after twice that time. For a file we will do the following:"><meta property="og:type" content="article"><meta property="og:url" content="https://www.njordy.com/2024/04/17/share_it/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-17T00:00:00+00:00"><meta property="article:modified_time" content="2024-04-17T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ShareIt, a cli for sharing files"><meta name=twitter:description content="TLDR: code can be found here.
In this blog post we will dive down in to how to build a small CLI for sharing files. The goal is to go over how to build a go cli for sharing files. We will set it up so that a shareable link will be created with a set expiration time and the object will be cleaned up after twice that time. For a file we will do the following:"><link href=https://www.njordy.com/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.njordy.com/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css></head><body><div class=content><header><div class=main><a href=https://www.njordy.com/>Njord tech blog</a></div><nav><a href=../../../../>Home</a>
<a href=../../../../posts>All posts</a>
<a href=../../../../about>About</a></nav></header><main><article><div class=title><h1 class=title>ShareIt, a cli for sharing files</h1><div class=meta>Posted on Apr 17, 2024</div></div><section class=body><p>TLDR: code can be found <a href=https://github.com/Njorda/homebrew-tools>here</a>.</p><p>In this blog post we will dive down in to how to build a small CLI for sharing files. The goal is to go over how to build a go cli for sharing files. We will set it up so that a shareable link will be created with a set expiration time and the object will be cleaned up after twice that time. For a file we will do the following:</p><ol><li>Upload the object to cloud blob storage with a expiration time so it will be deleted.</li><li>Create a presigned shareable link, any one with the link will be able to download the file</li><li>Copy the link to the clip board to make it easy to share for anyone.</li></ol><p>When we have the CLI we will set up so it can be installed through brew.</p><h1 id=build-the-cli>Build the CLI</h1><p>In order to keep it simple and avoid to many deps we will use the go standard package flags package for command line arguments.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>platform</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bucket</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>region</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>filePath</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ttl</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>parseFlags</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>platform</span>, <span style=color:#e6db74>&#34;platform&#34;</span>, <span style=color:#e6db74>&#34;aws&#34;</span>, <span style=color:#e6db74>&#34;The platform to store the file&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>filePath</span>, <span style=color:#e6db74>&#34;filePath&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;The file path&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bucket</span>, <span style=color:#e6db74>&#34;bucket&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;The bucket to use&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>region</span>, <span style=color:#e6db74>&#34;region&#34;</span>, <span style=color:#e6db74>&#34;eu-west-1&#34;</span>, <span style=color:#e6db74>&#34;The region to use&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>IntVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ttl</span>, <span style=color:#e6db74>&#34;ttl seconds&#34;</span>, <span style=color:#ae81ff>60</span>, <span style=color:#e6db74>&#34;The time to live for the tmp link in seconds&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>we will run this as the first thing in the <code>main</code> functions. The next step is to create the client to interact with blob storage. We will use AWS and S3 to keep it simple but this could be implemented for any blob storage.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>		<span style=color:#75715e>// Load the Shared AWS Configuration (~/.aws/config)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LoadDefaultConfig</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Region</span> = <span style=color:#a6e22e>region</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Create an Amazon S3 service client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>NewFromConfig</span>(<span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>path</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;/tmp/%s&#34;</span>, <span style=color:#a6e22e>filePath</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>uploadFile</span>(<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>bucket</span>, <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>filePath</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>presignClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>NewPresignClient</span>(<span style=color:#a6e22e>client</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>presignDocument</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>presignClient</span>, <span style=color:#a6e22e>bucket</span>, <span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Shareable link copied to clipboard, valid: %v seconds \n&#34;</span>, <span style=color:#a6e22e>ttl</span>)
</span></span></code></pre></div><p>The upload function if a slightly modified version of the AWS example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>uploadFile</span>(<span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>bucketName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>objectKey</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>fileName</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>expires</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>ttl</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>fileName</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;couldn&#39;t open file %v: %v&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>PutObject</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>PutObjectInput</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Bucket</span>:  <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>bucketName</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Key</span>:     <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>objectKey</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Body</span>:    <span style=color:#a6e22e>file</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Expires</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>expires</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;couldn&#39;t upload file %v to %v:%v. Here&#39;s why: %v&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>bucketName</span>, <span style=color:#a6e22e>objectKey</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can see that the expiration time of the file on s3 is twice the time to live(ttl) of the sharable link. We do not intend to be able to recreate the link twice but instead the user have to upload the file twice. The presign function is also similar to the AWS examples:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>presignDocument</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>presignClient</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>PresignClient</span>, <span style=color:#a6e22e>bucket</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>objectPath</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>params</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>GetObjectInput</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Bucket</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bucket</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Key</span>:    <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>objectPath</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>presignClient</span>.<span style=color:#a6e22e>PresignGetObject</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>		<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>params</span>,
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>opts</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>PresignOptions</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>Expires</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>ttl</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to presign: %s&#34;</span>, <span style=color:#a6e22e>objectPath</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And thus the complete CLI looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;flag&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/config&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/service/s3&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go/aws&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;golang.design/x/clipboard&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>platform</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bucket</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>region</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>filePath</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ttl</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>parseFlags</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>platform</span>, <span style=color:#e6db74>&#34;platform&#34;</span>, <span style=color:#e6db74>&#34;aws&#34;</span>, <span style=color:#e6db74>&#34;The platform to store the file&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>filePath</span>, <span style=color:#e6db74>&#34;filePath&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;The file path&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bucket</span>, <span style=color:#e6db74>&#34;bucket&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;The bucket to use&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>region</span>, <span style=color:#e6db74>&#34;region&#34;</span>, <span style=color:#e6db74>&#34;eu-west-1&#34;</span>, <span style=color:#e6db74>&#34;The region to use&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>IntVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ttl</span>, <span style=color:#e6db74>&#34;ttl seconds&#34;</span>, <span style=color:#ae81ff>60</span>, <span style=color:#e6db74>&#34;The time to live for the tmp link in seconds&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// UploadFile reads from a file and puts the data into an object in a bucket.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>uploadFile</span>(<span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>bucketName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>objectKey</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>fileName</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>expires</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>ttl</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>fileName</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;couldn&#39;t open file %v: %v&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>PutObject</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>PutObjectInput</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Bucket</span>:  <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>bucketName</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Key</span>:     <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>objectKey</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Body</span>:    <span style=color:#a6e22e>file</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Expires</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>expires</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;couldn&#39;t upload file %v to %v:%v. Here&#39;s why: %v&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>bucketName</span>, <span style=color:#a6e22e>objectKey</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>presignDocument</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>presignClient</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>PresignClient</span>, <span style=color:#a6e22e>bucket</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>objectPath</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>params</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>GetObjectInput</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Bucket</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bucket</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Key</span>:    <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>objectPath</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>presignClient</span>.<span style=color:#a6e22e>PresignGetObject</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>		<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>params</span>,
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>opts</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>PresignOptions</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>Expires</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>ttl</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to presign: %s&#34;</span>, <span style=color:#a6e22e>objectPath</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>parseFlags</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>url</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>platform</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;aws&#34;</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Load the Shared AWS Configuration (~/.aws/config)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LoadDefaultConfig</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Region</span> = <span style=color:#a6e22e>region</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Create an Amazon S3 service client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>NewFromConfig</span>(<span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>path</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;/tmp/%s&#34;</span>, <span style=color:#a6e22e>filePath</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>uploadFile</span>(<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>bucket</span>, <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>filePath</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>presignClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>NewPresignClient</span>(<span style=color:#a6e22e>client</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>presignDocument</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>presignClient</span>, <span style=color:#a6e22e>bucket</span>, <span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Shareable link copied to clipboard, valid: %v seconds \n&#34;</span>, <span style=color:#a6e22e>ttl</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;gcp&#34;</span>:
</span></span><span style=display:flex><span>		panic(<span style=color:#e6db74>&#34;gcp is not implemented&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>clipboard</span>.<span style=color:#a6e22e>Init</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>clipboard</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>clipboard</span>.<span style=color:#a6e22e>FmtText</span>, []byte(<span style=color:#a6e22e>url</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To run it you can do the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go run main.go --platform aws --filePath test.png --bucket test-bucket --region eu-west-
</span></span></code></pre></div><p>or compile it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build -o shareit .
</span></span><span style=display:flex><span>chmod +x ./shareit
</span></span><span style=display:flex><span>./shareit --platform aws --filePath test.png --bucket oskar-test-2 --region eu-west-1
</span></span></code></pre></div><h1 id=create-homebrew-package>Create homebrew package</h1><p>Homebrew offers <code>taps</code> as an alternative to add third party repositories. By default <code>tap</code> assumes the repository is on <code>GitHub</code>. We will combine this together with <a href=https://github.com/goreleaser/goreleaser>goreleaser</a> to build binaries for several platforms and push them back to github.</p><p>To get up and runing we need to do two things:</p><ol><li>add a <code>.goreleaser.yml</code> <a href=https://github.com/Njorda/homebrew-tools/blob/main/.goreleaser.yml>file at the root of the repo</a>.</li><li>add the <a href=https://github.com/Njorda/homebrew-tools/blob/main/.github/workflows/gorelease.yaml>github action</a> that will push the shareit.rb file back to the repo and build the binaries.</li></ol><p>Lets go over the different sections of the <code>.goreleaser.yml</code> and what id does:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>brews</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>shareit</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>homepage</span>: <span style=color:#ae81ff>https://github.com/Njorda/homebrew-tools</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>repository</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>Njorda</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>homebrew-tools</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>branch</span>: <span style=color:#ae81ff>main</span>
</span></span><span style=display:flex><span><span style=color:#f92672>builds</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>main</span>: <span style=color:#ae81ff>./src/shareit/</span>
</span></span></code></pre></div><p>Most of the yaml file is boiler plat from goreleases examples. The key differences are the values for <code>homepage</code>, <code>owner</code>(the org or person that has the repo) and <code>name</code>(the name of the repo). I mixed up the owner and forgot that I created it in an organisation and not on my private account. Another key difference from the examples are the <code>builds:main</code> which points to where the main go file lives.</p><p>The next step is to update the github action for the build, <code>.github/workflows/gorelease.yaml</code>. This is also boilerplate from the <a href=https://goreleaser.com/ci/actions/#workflow>goreleaser examples</a>.</p><p>The repos needs to be public to work.</p><p>That should be it and we should not be ready to create a release doing the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git tag v0.0.x
</span></span><span style=display:flex><span>git push origin v0.0.x
</span></span></code></pre></div><p>Check your github actions builds, mine can be found <a href=https://github.com/Njorda/homebrew-tools/actions>here</a>. When the actions are done and hopefully succeded. You can install it doing the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew tap Njorda/tools
</span></span><span style=display:flex><span>brew install ShareIt
</span></span></code></pre></div><p>You should then be able to run:</p><pre tabindex=0><code>shareit --help
</code></pre><p>And we are done. Hope you found it helpful and now know how to build a small CLI in go and how to distribute it with Homebrew.</p></section><div class=post-tags></div></article></main><footer><div style=display:flex></div><div class=footer-info>2024 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>