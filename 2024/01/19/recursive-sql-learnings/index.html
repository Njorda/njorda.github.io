<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Learnings from writing recursive SQL - Njord tech blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In this blog post we will go over some learnings from writing recursive queries. For example data we will use the Recursive queries blog post and the set up provided in the post as well, and thus not go over how to bring up the env in this post.
Avoiding cycles Writing Recursive queries it is easy to have cycles that. For a process at work I tried to do a graph traversal but ended up in a infinite loop, to avoid spilling sensitive information we will rely on a mock example based upon this example."><meta property="og:image" content><meta property="og:title" content="Learnings from writing recursive SQL"><meta property="og:description" content="In this blog post we will go over some learnings from writing recursive queries. For example data we will use the Recursive queries blog post and the set up provided in the post as well, and thus not go over how to bring up the env in this post.
Avoiding cycles Writing Recursive queries it is easy to have cycles that. For a process at work I tried to do a graph traversal but ended up in a infinite loop, to avoid spilling sensitive information we will rely on a mock example based upon this example."><meta property="og:type" content="article"><meta property="og:url" content="https://www.njordy.com/2024/01/19/recursive-sql-learnings/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-19T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-19T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Learnings from writing recursive SQL"><meta name=twitter:description content="In this blog post we will go over some learnings from writing recursive queries. For example data we will use the Recursive queries blog post and the set up provided in the post as well, and thus not go over how to bring up the env in this post.
Avoiding cycles Writing Recursive queries it is easy to have cycles that. For a process at work I tried to do a graph traversal but ended up in a infinite loop, to avoid spilling sensitive information we will rely on a mock example based upon this example."><link href=https://www.njordy.com/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.njordy.com/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css></head><body><div class=content><header><div class=main><a href=https://www.njordy.com/>Njord tech blog</a></div><nav><a href=../../../../>Home</a>
<a href=../../../../posts>All posts</a>
<a href=../../../../about>About</a></nav></header><main><article><div class=title><h1 class=title>Learnings from writing recursive SQL</h1><div class=meta>Posted on Jan 19, 2024</div></div><section class=body><p>In this blog post we will go over some learnings from writing recursive queries. For example data we will use the <a href=https://www.njordy.com/2024/01/10/recursive-sql/>Recursive queries</a> blog post and the set up provided in the post as well, and thus not go over how to bring up the env in this post.</p><h1 id=avoiding-cycles>Avoiding cycles</h1><p>Writing <code>Recursive</code> queries it is easy to have cycles that. For a process at work I tried to do a graph traversal but ended up in a infinite loop, to avoid spilling sensitive information we will rely on a mock example based upon <a href=https://duckdb.org/docs/sql/query_syntax/with.html>this example</a>. However the learning is still the same. The goal was to try to get all the nodes while traversing the graph. I was aiming for getting something like:</p><table><thead><tr><th>id</th><th style=text-align:center>name</th><th style=text-align:right>parent</th></tr></thead><tbody><tr><td>4</td><td style=text-align:center>2Pac</td><td style=text-align:right>6</td></tr><tr><td>6</td><td style=text-align:center>Rap</td><td style=text-align:right>7</td></tr><tr><td>7</td><td style=text-align:center>Music</td><td style=text-align:right>9</td></tr><tr><td>9</td><td style=text-align:center>Art</td><td style=text-align:right></td></tr></tbody></table><p>and tried to write the following query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> steps(id, name, subclassof) <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> id, name, subclassof 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2Pac&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> tag.id, tag.name, tag.subclassof
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag, steps
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> steps.subclassof<span style=color:#f92672>=</span>tag.id
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> steps <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>100</span>;
</span></span></code></pre></div><p>This queries ends up in an infinite loop. To get some kind of limit you can add <code>LIMIT 100</code>. Adding a limit clause is in general a good thing while doing development in order to reduce the risk for putting the database under load(as well as try to never do development on top of a active production database in order to not affect the application performance). The main issue is that since I return the <code>step.id</code> as the <code>node(id,...)</code> this will continue to match with the same row all over again. This could also have been avoided using <code>UNION</code> instead of <code>UNION ALL</code> . The correct query however is instead:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> steps(id, name, subclassof) <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> id, name, subclassof 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2Pac&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> tag.id, tag.name, tag.subclassof
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag, steps
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> steps.subclassof<span style=color:#f92672>=</span>tag.id
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> steps <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>100</span>;
</span></span></code></pre></div><p>Potentially I could also have switched the <code>UNION ALL</code> for <code>UNION</code> but this is also not supported for all databases(which is actually the case for the one I used at work).</p><h1 id=combining-multiple-ctes-with-recursive-queries>Combining multiple CTE:s with Recursive queries</h1><p>In the case of using the output of a previous CTE with a recursive query the syntax is slightly different, where the recursive keyword is moved to the first CTE statement even though it is related to a later query. In order to simply my recursive query I tried to use a CTE for making the recursive query simpler and thus write something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>WITH</span> tmp <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> id, name, subclassof
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag
</span></span><span style=display:flex><span>), <span style=color:#66d9ef>RECURSIVE</span> steps(id, name, subclassof) <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> id, name, subclassof 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tmp
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2Pac&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> tmp.id, tmp.name, tmp.subclassof
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tmp, steps
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> steps.subclassof<span style=color:#f92672>=</span>tmp.id
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> steps <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>100</span>;
</span></span></code></pre></div><p>However this will not work, which confused me and I found the answer hard to find, after trial and error but ended up figuring out that the structure should be the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span>  tmp <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> id, name, subclassof
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag
</span></span><span style=display:flex><span>), steps(id, name, subclassof) <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> id, name, subclassof 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tmp
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2Pac&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> tmp.id, tmp.name, tmp.subclassof
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tmp, steps
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> steps.subclassof<span style=color:#f92672>=</span>tmp.id
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> steps <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>100</span>;
</span></span></code></pre></div><h1 id=when-to-use-where-and-when-to-use-join>When to use <code>WHERE</code> and when to use <code>JOIN</code></h1><p>Obviously using a filtering and joining rows are not the same thing however similar results can be achieved. Thus this comes down to how YOU like to get the data out and what results you are looking for. Learning about recursive queries it felt like black magic and thus I though it was worth writing something about it. For example if we like to get the the path between nodes in a graph. If we start with the same data as in the previous examples the graph looks like this:</p><pre tabindex=0><code class=language-mermaid data-lang=mermaid>  graph BT;
U2 --&gt; Rock
Blur --&gt; Rock
Oasis --&gt; Rock
2Pac --&gt; Rap
Rock --&gt; Music
Rap --&gt; Music
Music --&gt; Art
Movies --&gt; Art
</code></pre><p>If we want to have the path between Oasis and Music we could use the following query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> steps(id, name, subclassof) <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> id, name, subclassof 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2Pac&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> tag.id, tag.name, tag.subclassof
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag, steps
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> steps.subclassof<span style=color:#f92672>=</span>tag.id
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> steps;
</span></span></code></pre></div><p>Which gives:</p><table><thead><tr><th>id</th><th style=text-align:center>name</th><th style=text-align:right>parent</th></tr></thead><tbody><tr><td>4</td><td style=text-align:center>2Pac</td><td style=text-align:right>6</td></tr><tr><td>6</td><td style=text-align:center>Rap</td><td style=text-align:right>7</td></tr><tr><td>7</td><td style=text-align:center>Music</td><td style=text-align:right>9</td></tr><tr><td>9</td><td style=text-align:center>Art</td><td style=text-align:right></td></tr></tbody></table><p>However we could also do it using a join and keeping the paths as a array.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> steps(startNode, endNode, path) <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> id <span style=color:#66d9ef>as</span> startNode
</span></span><span style=display:flex><span>        , subclassof <span style=color:#66d9ef>as</span> endNode
</span></span><span style=display:flex><span>        , ARRAY[id,subclassof] 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2Pac&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> steps.startNode
</span></span><span style=display:flex><span>        , tag.subclassof
</span></span><span style=display:flex><span>        , steps.path <span style=color:#f92672>||</span> subclassof <span style=color:#66d9ef>AS</span> path
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> steps
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>JOIN</span> tag <span style=color:#66d9ef>ON</span> steps.endNode<span style=color:#f92672>=</span>tag.id
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> tag.subclassof <span style=color:#f92672>!=</span> <span style=color:#66d9ef>ALL</span>(steps.path)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> steps;
</span></span></code></pre></div><p>This gives the following result:</p><p>startnode | endnode | path
&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&ndash;
4 | 6 | {4,6}
4 | 7 | {4,6,7}
4 | 9 | {4,6,7,9}</p><p>However we could also get the path from doing the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> steps(id, name, path) <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> tag.subclassof
</span></span><span style=display:flex><span>        , name
</span></span><span style=display:flex><span>        , ARRAY[id] 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2Pac&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> tag.subclassof
</span></span><span style=display:flex><span>        , steps.name
</span></span><span style=display:flex><span>        , steps.path <span style=color:#f92672>||</span> tag.subclassof
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag, steps
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> steps.id<span style=color:#f92672>=</span>tag.id
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>AND</span> tag.subclassof <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> steps <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>10</span>;
</span></span></code></pre></div><p>Which gives:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> steps <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span> id <span style=color:#f92672>|</span> name <span style=color:#f92672>|</span>  path
</span></span><span style=display:flex><span><span style=color:#75715e>----+------+---------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#ae81ff>6</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>2</span>Pac <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>4</span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>7</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>2</span>Pac <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>7</span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>9</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>2</span>Pac <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>7</span>,<span style=color:#ae81ff>9</span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><p>Probably the title of the section is not that good, since the conclusion is the obvious answer that it depends on that you looking for(as always there is multiple ways to get there)</p><h1 id=optimizations>Optimizations</h1><p>As with any Query indexes can improve performance for the variables used for filtering(<code>WHERE</code>) and joining(<code>JOIN</code>) data together. Therefore make sure to run tests, use <code>EXPLAIN ANALYSE</code> in order to add indexes to increase performance.</p></section><div class=post-tags></div></article></main><footer><div style=display:flex></div><div class=footer-info>2024 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>