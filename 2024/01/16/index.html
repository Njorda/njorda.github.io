<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>SQL for gcloud bucket - Njord tech blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="TLDR: https://github.com/Njorda/cloudsql/tree/main
The goal with this blog post is to build a small tool to query Google Cloud buckets. We will do this using ChatGPT, I feel like I need to be even better at prompting for coding help. So to start by setting some constraints to limit the scope and make it a reasonable task to finish in a hour we will use go and we will limit our self to SELECT with WHERE we will support predicate push downs but thats it."><meta property="og:image" content><meta property="og:title" content="SQL for gcloud bucket"><meta property="og:description" content="TLDR: https://github.com/Njorda/cloudsql/tree/main
The goal with this blog post is to build a small tool to query Google Cloud buckets. We will do this using ChatGPT, I feel like I need to be even better at prompting for coding help. So to start by setting some constraints to limit the scope and make it a reasonable task to finish in a hour we will use go and we will limit our self to SELECT with WHERE we will support predicate push downs but thats it."><meta property="og:type" content="article"><meta property="og:url" content="https://www.njordy.com/2024/01/16/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-16T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-16T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="SQL for gcloud bucket"><meta name=twitter:description content="TLDR: https://github.com/Njorda/cloudsql/tree/main
The goal with this blog post is to build a small tool to query Google Cloud buckets. We will do this using ChatGPT, I feel like I need to be even better at prompting for coding help. So to start by setting some constraints to limit the scope and make it a reasonable task to finish in a hour we will use go and we will limit our self to SELECT with WHERE we will support predicate push downs but thats it."><link href=https://www.njordy.com/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.njordy.com/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css></head><body><div class=content><header><div class=main><a href=https://www.njordy.com/>Njord tech blog</a></div><nav><a href=../../../>Home</a>
<a href=../../../posts>All posts</a>
<a href=../../../about>About</a></nav></header><main><article><div class=title><h1 class=title>SQL for gcloud bucket</h1><div class=meta>Posted on Jan 16, 2024</div></div><section class=body><p>TLDR: <a href=https://github.com/Njorda/cloudsql/tree/main>https://github.com/Njorda/cloudsql/tree/main</a></p><p>The goal with this blog post is to build a small tool to query Google Cloud buckets. We will do this using ChatGPT, I feel like I need to be even better at prompting for coding help. So to start by setting some constraints to limit the scope and make it a reasonable task to finish in a hour we will use <code>go</code> and we will limit our self to <code>SELECT</code> with <code>WHERE</code> we will support predicate push downs but thats it. We also aim for creating an experiance that is similar to <a href="https://www.postgresql.org/docs/current/app-psql.html#:~:text=Description,or%20from%20command%20line%20arguments.">psql</a></p><p>The first step is to be able to parse queries, we will not support <a href=https://www.postgresql.org/docs/current/queries-with.html>Common Table Expressions</a> CTE or any other fancy feature for that part to make life easier. Initially I though to not include the exact prompts but after realising it might be tricky for people to play around with and reproduce I decided to keep them in an appendix. However in the end I changed my mind again to not do this since it was so much back and fourth with ChatGPT4. The first step in order to build my small CLI is to get the overview tasks, the steps I decided to follow for the project is the following:</p><ol><li>Lexer or Tokenizer: The lexer takes the SQL query as input and breaks it down into tokens. Tokens are the smallest units that have meaning in SQL, like keywords (SELECT, FROM, WHERE), identifiers (table names, column names), operators (=, >, &lt;), and literals (numeric values, strings).</li><li>Intermediate Representation: The parser typically converts the query into an intermediate representation (IR). This IR is a data structure (like a parse tree or an abstract syntax tree) that represents the parsed query. The IR is used by other components of the database system to execute the query.</li><li>Generate API call: Extract the paramters for the API call to google cloud storage.</li></ol><p>The code will be broken down to the following structure:</p><p>├── lexer
│ ├── lexer.go
│ ├── lexer_test.go
├── parser
│ ├── sql_parser.go
│ ├── sql_parser_test.go
├── main.go
├── go.mod
├── go.sum</p><p>The code for making the API calls will live in main.</p><p>The first step is to build the parser, ChatGPT4 did most of the heavy lifting and the code only required some minor changes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>lexer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;unicode&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>TokenType</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>keywords</span> = []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;SELECT&#34;</span>, <span style=color:#e6db74>&#34;FROM&#34;</span>, <span style=color:#e6db74>&#34;WHERE&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>TOKEN_EOF</span> <span style=color:#a6e22e>TokenType</span> = <span style=color:#66d9ef>iota</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>TOKEN_ERROR</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>TOKEN_KEYWORD</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>TOKEN_IDENTIFIER</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>TOKEN_SYMBOL</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Token</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Type</span>    <span style=color:#a6e22e>TokenType</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Literal</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Lexer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>input</span>        <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>position</span>     <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>readPosition</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span>           <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewLexer</span>(<span style=color:#a6e22e>input</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Lexer</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>l</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Lexer</span>{<span style=color:#a6e22e>input</span>: <span style=color:#a6e22e>input</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>readChar</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>l</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Lexer</span>) <span style=color:#a6e22e>readChar</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>readPosition</span> <span style=color:#f92672>&gt;=</span> len(<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>input</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>ch</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>ch</span> = <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>input</span>[<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>readPosition</span>]
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>position</span> = <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>readPosition</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>readPosition</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Lexer</span>) <span style=color:#a6e22e>NextToken</span>() <span style=color:#a6e22e>Token</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>tok</span> <span style=color:#a6e22e>Token</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>skipWhitespace</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>ch</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tok</span> = <span style=color:#a6e22e>Token</span>{<span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>TOKEN_EOF</span>, <span style=color:#a6e22e>Literal</span>: string(<span style=color:#e6db74>&#34;&#34;</span>)}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;=&#39;</span>, <span style=color:#e6db74>&#39;;&#39;</span>, <span style=color:#e6db74>&#39;(&#39;</span>, <span style=color:#e6db74>&#39;)&#39;</span>, <span style=color:#e6db74>&#39;,&#39;</span>, <span style=color:#e6db74>&#39;\&#39;&#39;</span>, <span style=color:#e6db74>&#39;/&#39;</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tok</span> = <span style=color:#a6e22e>Token</span>{<span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>TOKEN_SYMBOL</span>, <span style=color:#a6e22e>Literal</span>: string(<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>ch</span>)}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>readChar</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isLetter</span>(<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>ch</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>literal</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>readIdentifier</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>keyword</span>(<span style=color:#a6e22e>literal</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>tok</span> = <span style=color:#a6e22e>Token</span>{<span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>TOKEN_KEYWORD</span>, <span style=color:#a6e22e>Literal</span>: <span style=color:#a6e22e>literal</span>}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>tok</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>tok</span> = <span style=color:#a6e22e>Token</span>{<span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>TOKEN_IDENTIFIER</span>, <span style=color:#a6e22e>Literal</span>: <span style=color:#a6e22e>literal</span>}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>tok</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tok</span> = <span style=color:#a6e22e>Token</span>{<span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>TOKEN_ERROR</span>, <span style=color:#a6e22e>Literal</span>: string(<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>ch</span>)}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>readChar</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>tok</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>keyword</span>(<span style=color:#a6e22e>literal</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>keywords</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>literal</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Lexer</span>) <span style=color:#a6e22e>readIdentifier</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>position</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>position</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>isLetter</span>(<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>ch</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>readChar</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>input</span>[<span style=color:#a6e22e>position</span>:<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>position</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>isLetter</span>(<span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>IsLetter</span>(rune(<span style=color:#a6e22e>ch</span>)) <span style=color:#f92672>||</span> <span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;_&#39;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;%&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Lexer</span>) <span style=color:#a6e22e>skipWhitespace</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;\t&#39;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;\n&#39;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;\r&#39;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>readChar</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The code also contains a test which shows the output, check <a href=https://github.com/Njorda/cloudsql/blob/main/lexer/lexer_test.go>here</a>. Next step is to parse the tokenized the input:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>parser</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/Njorda.cloudsql/lexer&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>KeyValue</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Key</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Value</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>SQLQuery</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Select</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>From</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Where</span>  <span style=color:#a6e22e>KeyValue</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Equals</span> <span style=color:#a6e22e>KeyValue</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Lets do it like the parser instead!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Parser</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>query</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>Lexer</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewParser</span>(<span style=color:#a6e22e>input</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Parser</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Parser</span>{<span style=color:#a6e22e>query</span>: <span style=color:#f92672>*</span><span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>NewLexer</span>(<span style=color:#a6e22e>input</span>)}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Parser</span>) <span style=color:#a6e22e>nextIdentifier</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>NextToken</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>TOKEN_SYMBOL</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Literal</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ParseSQLQuery parses a simple SQL query
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Parser</span>) <span style=color:#a6e22e>ParseQuery</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>SQLQuery</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>query</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>SQLQuery</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>tok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>NextToken</span>(); <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>TOKEN_EOF</span>; <span style=color:#a6e22e>tok</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>NextToken</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>TOKEN_KEYWORD</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToUpper</span>(<span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Literal</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;SELECT&#34;</span>:
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>tok</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>NextToken</span>(); <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>TOKEN_IDENTIFIER</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>TOKEN_SYMBOL</span>; <span style=color:#a6e22e>tok</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>NextToken</span>() {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>TOKEN_SYMBOL</span>:
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>TOKEN_IDENTIFIER</span>:
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Select</span> = append(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Select</span>, <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Literal</span>)
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>fallthrough</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;FROM&#34;</span>:
</span></span><span style=display:flex><span>				<span style=color:#75715e>// no inner query support
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>From</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>NextToken</span>().<span style=color:#a6e22e>Literal</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Currently only supports one where clause, either with = or %.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;WHERE&#34;</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>kV</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>KeyValue</span>{}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>kV</span>.<span style=color:#a6e22e>Key</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>nextIdentifier</span>()
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Need to get all the stuff until we get the end of it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>kV</span>.<span style=color:#a6e22e>Value</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>nextIdentifier</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Exit</span>:
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>tok</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>NextToken</span>(); <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>TOKEN_IDENTIFIER</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>TOKEN_SYMBOL</span>; <span style=color:#a6e22e>tok</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>NextToken</span>() {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>TOKEN_SYMBOL</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Literal</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>`/`</span>:
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>kV</span>.<span style=color:#a6e22e>Value</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v%v&#34;</span>, <span style=color:#a6e22e>kV</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Literal</span>)
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>TOKEN_SYMBOL</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Literal</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>`=`</span>:
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>lexer</span>.<span style=color:#a6e22e>TOKEN_IDENTIFIER</span>:
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>kV</span>.<span style=color:#a6e22e>Value</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v%v&#34;</span>, <span style=color:#a6e22e>kV</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>Literal</span>)
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>continue</span> <span style=color:#a6e22e>Exit</span>
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasSuffix</span>(<span style=color:#a6e22e>kV</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#e6db74>&#34;%&#34;</span>) {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>kV</span>.<span style=color:#a6e22e>Value</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSuffix</span>(<span style=color:#a6e22e>kV</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#e6db74>&#34;%&#34;</span>)
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Where</span> = <span style=color:#a6e22e>kV</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Equals</span> = <span style=color:#a6e22e>kV</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>query</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Most of the code so far as been written baser upon the go standard libs. However for the CLI we will use a <a href=github.com/chzyer/readline>library</a> in order to give a lot of the basic functionality such as searching previous commands and history. We will also use a <a href=github.com/jedib0t/go-pretty/v6/table>library</a> for pretty printing the results.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;cloud.google.com/go/storage&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/Njorda.cloudsql/parser&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;google.golang.org/api/iterator&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/chzyer/readline&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/jedib0t/go-pretty/v6/table&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//var columns = []string{&#34;name&#34;, &#34;size&#34;, &#34;timeCreated&#34;, &#34;timeUpdated&#34;, &#34;storageClass&#34;, &#34;owner&#34;, &#34;contentType&#34;, &#34;contentEncoding&#34;, &#34;contentDisposition&#34;, &#34;retentionTime&#34;, &#34;updated&#34;}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleInput</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>storage</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>input</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>query</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>NewParser</span>(<span style=color:#a6e22e>input</span>).<span style=color:#a6e22e>ParseQuery</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Name is the only value we have ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>rows</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ListObjects</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>From</span>, <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Where</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Select</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>format</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Select</span>, <span style=color:#a6e22e>rows</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// CreateClient initializes a new Google Cloud Storage client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CreateClient</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>storage</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>storage</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>client</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GetObjects lists objects in a given bucket, optionally filtered by a prefix
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GetObjects</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>storage</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>bucketName</span>, <span style=color:#a6e22e>objet</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>selected</span> []<span style=color:#66d9ef>string</span>) ([]<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>attrs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Bucket</span>(<span style=color:#a6e22e>bucketName</span>).<span style=color:#a6e22e>Object</span>(<span style=color:#a6e22e>objet</span>).<span style=color:#a6e22e>Attrs</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>objects</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;name&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>Name</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;size&#34;</span>] = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%d&#34;</span>, <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>Size</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;timeCreated&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>Created</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;timeUpdated&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>Updated</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;storageClass&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>StorageClass</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;owner&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>Owner</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;contentType&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>ContentType</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;contentEncoding&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>ContentEncoding</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;contentDisposition&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>ContentDisposition</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;retentionTime&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>RetentionExpirationTime</span>.<span style=color:#a6e22e>GoString</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;updated&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>Updated</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>column</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>selected</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>objects</span> = append(<span style=color:#a6e22e>objects</span>, <span style=color:#a6e22e>out</span>[<span style=color:#a6e22e>column</span>])
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>objects</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ListObjects lists objects in a given bucket, optionally filtered by a prefix
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ListObjects</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>storage</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>bucketName</span>, <span style=color:#a6e22e>prefix</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>selected</span> []<span style=color:#66d9ef>string</span>) ([][]<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;The prefix is: &#34;</span>, <span style=color:#a6e22e>prefix</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>it</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Bucket</span>(<span style=color:#a6e22e>bucketName</span>).<span style=color:#a6e22e>Objects</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>storage</span>.<span style=color:#a6e22e>Query</span>{<span style=color:#a6e22e>Prefix</span>: <span style=color:#a6e22e>prefix</span>})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>rows</span> [][]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>attrs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>it</span>.<span style=color:#a6e22e>Next</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>iterator</span>.<span style=color:#a6e22e>Done</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Here we could do something with reflect to get all the stuff out!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// This would be the way.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>out</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;name&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>Name</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;size&#34;</span>] = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%d&#34;</span>, <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>Size</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;timeCreated&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>Created</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;timeUpdated&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>Updated</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;storageClass&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>StorageClass</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;owner&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>Owner</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;contentType&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>ContentType</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;contentEncoding&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>ContentEncoding</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;contentDisposition&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>ContentDisposition</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;retentionTime&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>RetentionExpirationTime</span>.<span style=color:#a6e22e>GoString</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span>[<span style=color:#e6db74>&#34;updated&#34;</span>] = <span style=color:#a6e22e>attrs</span>.<span style=color:#a6e22e>Updated</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>row</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>string</span>{}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>column</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>selected</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>row</span> = append(<span style=color:#a6e22e>row</span>, <span style=color:#a6e22e>out</span>[<span style=color:#a6e22e>column</span>])
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>rows</span> = append(<span style=color:#a6e22e>rows</span>, <span style=color:#a6e22e>row</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rows</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>format</span>(<span style=color:#a6e22e>columns</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>tuples</span> [][]<span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>table</span>.<span style=color:#a6e22e>NewWriter</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>SetOutputMirror</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>row</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>table</span>.<span style=color:#a6e22e>Row</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>col</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>columns</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>row</span> = append(<span style=color:#a6e22e>row</span>, <span style=color:#a6e22e>col</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>AppendHeader</span>(<span style=color:#a6e22e>row</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>rows</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>table</span>.<span style=color:#a6e22e>Row</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tuple</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tuples</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>row</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>table</span>.<span style=color:#a6e22e>Row</span>{}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>val</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tuple</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>row</span> = append(<span style=color:#a6e22e>row</span>, <span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>rows</span> = append(<span style=color:#a6e22e>rows</span>, <span style=color:#a6e22e>row</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>AppendRows</span>(<span style=color:#a6e22e>rows</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>AppendSeparator</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Render</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>CreateClient</span>(<span style=color:#a6e22e>ctx</span>) <span style=color:#75715e>// Assuming CreateClient is a function you&#39;ve defined
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>rl</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>readline</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;GCSQL&gt; &#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Welcome to GCSQL, the Google Cloud Storage SQL interface.&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Type &#39;EXIT&#39; to quit.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>input</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>Readline</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#75715e>// io.EOF, readline.ErrInterrupt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToUpper</span>(<span style=color:#a6e22e>input</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;EXIT&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Goodbye!&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Add the input to history
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>SaveHistory</span>(<span style=color:#a6e22e>input</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Handle the input
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>handleInput</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>input</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Error: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In order to build the binary and try the CLI out <code>go build -o cloudsql</code> and then <code>./cloudsql</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>GCSQL&gt; SELECT name, size FROM ceedai WHERE path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ceedai/files/%&#39;</span>;
</span></span><span style=display:flex><span>+---------------------------------------------------------------------------------+----------+
</span></span><span style=display:flex><span>| NAME                                                                            | SIZE     |
</span></span><span style=display:flex><span>+---------------------------------------------------------------------------------+----------+
</span></span><span style=display:flex><span>| ceedai/files/tmp1.pdf                                                           | <span style=color:#ae81ff>3372362</span>  |
</span></span><span style=display:flex><span>| ceedai/files/smp.pdf                                                            | <span style=color:#ae81ff>989059</span>   |
</span></span><span style=display:flex><span>| ceedai/files/12.pdf                                                             | <span style=color:#ae81ff>72202</span>    |
</span></span><span style=display:flex><span>| ceedai/files/p29-neumann-cidr20.pdf                                             | <span style=color:#ae81ff>335856</span>   |
</span></span><span style=display:flex><span>| ceedai/files/simon.json                                                         | <span style=color:#ae81ff>30</span>       |
</span></span><span style=display:flex><span>+---------------------------------------------------------------------------------+----------+
</span></span><span style=display:flex><span>GCSQL&gt;
</span></span></code></pre></div><p>The current implementation is very limited but demonstrates how it can be implemented. Feel free to fork the code and add features. I might come back in later posts and add more features.</p></section><div class=post-tags></div></article></main><footer><div style=display:flex></div><div class=footer-info>2024 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>