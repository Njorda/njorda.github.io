<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Recursive queries - Njord tech blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I coupe of weeks ago I came across that Postgres supports recursive queries and thus we will take a deep dive in this blog post on the concept of recursion in SQL. The docs for postgres and recursive queries can be found here if you are not familiar with CTE I recommend you to start with that. In this blog post we will start with exploring this concept in Postgres before we jump to DuckDB."><meta property="og:image" content><meta property="og:title" content="Recursive queries"><meta property="og:description" content="I coupe of weeks ago I came across that Postgres supports recursive queries and thus we will take a deep dive in this blog post on the concept of recursion in SQL. The docs for postgres and recursive queries can be found here if you are not familiar with CTE I recommend you to start with that. In this blog post we will start with exploring this concept in Postgres before we jump to DuckDB."><meta property="og:type" content="article"><meta property="og:url" content="https://www.njordy.com/2024/01/10/recursive-sql/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-10T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-10T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Recursive queries"><meta name=twitter:description content="I coupe of weeks ago I came across that Postgres supports recursive queries and thus we will take a deep dive in this blog post on the concept of recursion in SQL. The docs for postgres and recursive queries can be found here if you are not familiar with CTE I recommend you to start with that. In this blog post we will start with exploring this concept in Postgres before we jump to DuckDB."><link href=https://www.njordy.com/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.njordy.com/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css></head><body><div class=content><header><div class=main><a href=https://www.njordy.com/>Njord tech blog</a></div><nav><a href=../../../../>Home</a>
<a href=../../../../posts>All posts</a>
<a href=../../../../about>About</a></nav></header><main><article><div class=title><h1 class=title>Recursive queries</h1><div class=meta>Posted on Jan 10, 2024</div></div><section class=body><p>I coupe of weeks ago I came across that Postgres supports recursive queries and thus we will take a deep dive in this blog post on the concept of recursion in SQL. The docs for postgres and recursive queries can be found <a href=https://www.postgresql.org/docs/current/queries-with.html#QUERIES-WITH-RECURSIVE>here</a> if you are not familiar with <a href=https://www.postgresql.org/docs/current/queries-with.html>CTE</a> I recommend you to start with that. In this blog post we will start with exploring this concept in Postgres before we jump to <a href=https://duckdb.org/>DuckDB</a>.</p><h1 id=recursive-queries-in-postgres>RECURSIVE queries in postgres</h1><p>In order to have a postgres instance to play around with we will use docker, we will not deep dive to much in the setup but rather leave that for your own exploration:</p><p>Start a postgres instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --rm --name postgresql -p 5432:5432 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-e POSTGRES_USER<span style=color:#f92672>=</span>admin -e POSTGRES_PASSWORD<span style=color:#f92672>=</span>admin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-e POSTGRES_DB<span style=color:#f92672>=</span>test <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-d postgres:16.1
</span></span></code></pre></div><p>Connect using psql:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it postgresql psql -d test -U admin
</span></span></code></pre></div><p>You should now have a postgres instance with in which you can play around.</p><p>So what is a <code>Recursive</code> sql query? A recursive SQL query allow for a query to reference is own output. This is done using the <code>WITH</code> key word in combination with <code>RECURSIVE</code>, it is important to notice here that the keyword <code>RECURSIVE</code> changes the <code>WITH</code> statement from being a syntactic feature to instead introducing a new behaviour. Personally I think this introduces some confusion around <code>RECURSIVE</code>. Here is an example of a recursive query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> t(n) <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> n<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>FROM</span> t <span style=color:#66d9ef>WHERE</span> n <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>sum</span>(n) <span style=color:#66d9ef>FROM</span> t;
</span></span></code></pre></div><p>A recursive query follows the form, of <code>WITH</code> followed by a query and then a <code>UNION ALL</code> term, the <code>UNION</code> term can be though of as the recursive part. In this case the query will sum all integers from 0 to 100, which is 5050. This example is slightly to simple to properly understand recursion and how it can be used so lets make a some what more realistic example. I will take the example from by duckdb <a href=https://duckdb.org/docs/sql/query_syntax/with.html#recursive-ctes>here</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> tag (id INT, name VARCHAR, subclassof INT);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> tag <span style=color:#66d9ef>VALUES</span>
</span></span><span style=display:flex><span> (<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;U2&#39;</span>,     <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span> (<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;Blur&#39;</span>,   <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span> (<span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#39;Oasis&#39;</span>,  <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span> (<span style=color:#ae81ff>4</span>, <span style=color:#e6db74>&#39;2Pac&#39;</span>,   <span style=color:#ae81ff>6</span>),
</span></span><span style=display:flex><span> (<span style=color:#ae81ff>5</span>, <span style=color:#e6db74>&#39;Rock&#39;</span>,   <span style=color:#ae81ff>7</span>),
</span></span><span style=display:flex><span> (<span style=color:#ae81ff>6</span>, <span style=color:#e6db74>&#39;Rap&#39;</span>,    <span style=color:#ae81ff>7</span>),
</span></span><span style=display:flex><span> (<span style=color:#ae81ff>7</span>, <span style=color:#e6db74>&#39;Music&#39;</span>,  <span style=color:#ae81ff>9</span>),
</span></span><span style=display:flex><span> (<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>&#39;Movies&#39;</span>, <span style=color:#ae81ff>9</span>),
</span></span><span style=display:flex><span> (<span style=color:#ae81ff>9</span>, <span style=color:#e6db74>&#39;Art&#39;</span>, <span style=color:#66d9ef>NULL</span>);
</span></span></code></pre></div><p>Feel free to run <code>SELECT * FROM tag;</code> to check out the table. Using recursive we could try to answere question such as, what is the path between <code>2Pac</code> and <code>Art</code>?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> steps(id, name, subclassof) <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> id, name, subclassof 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2Pac&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> tag.id, tag.name, tag.subclassof
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag, steps
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> steps.subclassof<span style=color:#f92672>=</span>tag.id
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> steps;
</span></span></code></pre></div><p>The output should be:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>id <span style=color:#f92672>|</span> name  <span style=color:#f92672>|</span> subclassof
</span></span><span style=display:flex><span><span style=color:#75715e>----+-------+------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#ae81ff>4</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>2</span>Pac  <span style=color:#f92672>|</span>          <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>6</span> <span style=color:#f92672>|</span> Rap   <span style=color:#f92672>|</span>          <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>7</span> <span style=color:#f92672>|</span> Music <span style=color:#f92672>|</span>          <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>9</span> <span style=color:#f92672>|</span> Art   <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>4</span> <span style=color:#66d9ef>rows</span>)
</span></span></code></pre></div><p>For postgres even though the terminology is recursive the query is evaluated iteratively. This should give you an example on how to traverse a graph like structure using SQL. An alternative do doing this using postgres is to use DuckDB for the compute and graph traversal.</p><h1 id=recursive-queries-from-duckdb-on-postgres>RECURSIVE queries from duckdb on postgres.</h1><p>The first step is to create a new shell inside the docker container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it postgresql /bin/bash
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt-get update
</span></span><span style=display:flex><span>apt-get install curl -y
</span></span><span style=display:flex><span>apt-get install unzip
</span></span><span style=display:flex><span>curl -OL https://github.com/duckdb/duckdb/releases/download/v0.9.2/duckdb_cli-linux-amd64.zip
</span></span><span style=display:flex><span>unzip duckdb_cli-linux-amd64.zip
</span></span><span style=display:flex><span>./duckdb
</span></span></code></pre></div><p>Then it is time to install and load the postgres connector:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span>D INSTALL postgres_scanner;
</span></span><span style=display:flex><span>D <span style=color:#66d9ef>LOAD</span> postgres_scanner;
</span></span></code></pre></div><p>The next step is to connect to the postgres instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span>D ATTACH <span style=color:#e6db74>&#39;host=localhost port=5432 dbname=test connect_timeout=10 user=admin password=admin&#39;</span> <span style=color:#66d9ef>AS</span> postgres_db (<span style=color:#66d9ef>TYPE</span> postgres);
</span></span><span style=display:flex><span>D USE postgres_db; <span style=color:#75715e>-- Otherwise the use postgres_db.public.tag;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>D <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> tag;
</span></span><span style=display:flex><span>D <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> postgres_db.<span style=color:#66d9ef>public</span>.tag;
</span></span></code></pre></div><p>We can then run <code>RECURSIVE</code> query through duckdb:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> steps(id, name, subclassof) <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> id, name, subclassof 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2Pac&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> tag.id, tag.name, tag.subclassof
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> tag, steps
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> steps.subclassof<span style=color:#f92672>=</span>tag.id
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> steps;
</span></span></code></pre></div><p>which gives:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>┌───────┬─────────┬────────────┐</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>│</span>  id   <span style=color:#960050;background-color:#1e0010>│</span>  name   <span style=color:#960050;background-color:#1e0010>│</span> subclassof <span style=color:#960050;background-color:#1e0010>│</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>│</span> int32 <span style=color:#960050;background-color:#1e0010>│</span> varchar <span style=color:#960050;background-color:#1e0010>│</span>   int32    <span style=color:#960050;background-color:#1e0010>│</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>├───────┼─────────┼────────────┤</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>│</span>     <span style=color:#ae81ff>4</span> <span style=color:#960050;background-color:#1e0010>│</span> <span style=color:#ae81ff>2</span>Pac    <span style=color:#960050;background-color:#1e0010>│</span>          <span style=color:#ae81ff>6</span> <span style=color:#960050;background-color:#1e0010>│</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>│</span>     <span style=color:#ae81ff>6</span> <span style=color:#960050;background-color:#1e0010>│</span> Rap     <span style=color:#960050;background-color:#1e0010>│</span>          <span style=color:#ae81ff>7</span> <span style=color:#960050;background-color:#1e0010>│</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>│</span>     <span style=color:#ae81ff>7</span> <span style=color:#960050;background-color:#1e0010>│</span> Music   <span style=color:#960050;background-color:#1e0010>│</span>          <span style=color:#ae81ff>9</span> <span style=color:#960050;background-color:#1e0010>│</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>│</span>     <span style=color:#ae81ff>9</span> <span style=color:#960050;background-color:#1e0010>│</span> Art     <span style=color:#960050;background-color:#1e0010>│</span>            <span style=color:#960050;background-color:#1e0010>│</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>└───────┴─────────┴────────────┘</span>
</span></span></code></pre></div><p>Thats it, now you are ready to do <code>RECURSIVE</code> queries.</p></section><div class=post-tags></div></article></main><footer><div style=display:flex></div><div class=footer-info>2024 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>