<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Go compiler optimizations - Njord tech blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This is based upon the new feature released in go v1.20 where the compiler can optimize using a pprof file.
In order to run the pprof we will use flags:
flag.Parse() if *cpuprofile != &#34;&#34; { f, err := os.Create(*cpuprofile) if err != nil { log.Fatal(err) } pprof.StartCPUProfile(f) defer pprof.StopCPUProfile() } more info can be found here.
In order to run the profiling use the following command:
go run main.go -cpuprofile=prof."><meta property="og:image" content><meta property="og:title" content="Go compiler optimizations"><meta property="og:description" content="This is based upon the new feature released in go v1.20 where the compiler can optimize using a pprof file.
In order to run the pprof we will use flags:
flag.Parse() if *cpuprofile != &#34;&#34; { f, err := os.Create(*cpuprofile) if err != nil { log.Fatal(err) } pprof.StartCPUProfile(f) defer pprof.StopCPUProfile() } more info can be found here.
In order to run the profiling use the following command:
go run main.go -cpuprofile=prof."><meta property="og:type" content="article"><meta property="og:url" content="https://njorda.github.io/2023/02/08/Profile-guided_inlining_optimization/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-08T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-08T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go compiler optimizations"><meta name=twitter:description content="This is based upon the new feature released in go v1.20 where the compiler can optimize using a pprof file.
In order to run the pprof we will use flags:
flag.Parse() if *cpuprofile != &#34;&#34; { f, err := os.Create(*cpuprofile) if err != nil { log.Fatal(err) } pprof.StartCPUProfile(f) defer pprof.StopCPUProfile() } more info can be found here.
In order to run the profiling use the following command:
go run main.go -cpuprofile=prof."><link href=https://njorda.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://njorda.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css></head><body><div class=content><header><div class=main><a href=https://njorda.github.io/>Njord tech blog</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a></nav></header><main><article><div class=title><h1 class=title>Go compiler optimizations</h1><div class=meta>Posted on Feb 8, 2023</div></div><section class=body><p>This is based upon the new feature released in <a href=https://tip.golang.org/doc/go1.20>go v1.20</a> where the compiler can optimize using a pprof file.</p><p>In order to run the pprof we will use flags:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cpuprofile</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>cpuprofile</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pprof</span>.<span style=color:#a6e22e>StartCPUProfile</span>(<span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>pprof</span>.<span style=color:#a6e22e>StopCPUProfile</span>()
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>more info can be found <a href=https://go.dev/blog/pprof>here</a>.</p><p>In order to run the profiling use the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go run main.go -cpuprofile<span style=color:#f92672>=</span>prof.prof
</span></span></code></pre></div><p>The specific information related to how the complier will optimize the code can be found <a href=https://tip.golang.org/doc/go1.20#compiler>here</a>. But why is this relevant? It has shown that this can allow for inlining to be optimized:</p><blockquote><p>Benchmarks for a representative set of Go programs show enabling profile-guided inlining optimization improves performance about 3â€“4%.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build -pgo<span style=color:#f92672>=</span>prof.prof
</span></span></code></pre></div><p>to run the code use:</p><pre tabindex=0><code>./compiler
</code></pre><p>The complete code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;flag&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;runtime/pprof&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/apache/arrow/go/v10/arrow&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/apache/arrow/go/v10/arrow/array&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/apache/arrow/go/v10/arrow/memory&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cpuprofile</span> = <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;cpuprofile&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;write cpu profile to file&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cpuprofile</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>cpuprofile</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pprof</span>.<span style=color:#a6e22e>StartCPUProfile</span>(<span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>pprof</span>.<span style=color:#a6e22e>StopCPUProfile</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>arrowFunc</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>arrowFunc</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pool</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>memory</span>.<span style=color:#a6e22e>NewGoAllocator</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lb</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>array</span>.<span style=color:#a6e22e>NewFixedSizeListBuilder</span>(<span style=color:#a6e22e>pool</span>, <span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>arrow</span>.<span style=color:#a6e22e>PrimitiveTypes</span>.<span style=color:#a6e22e>Int64</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Release</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>ValueBuilder</span>().(<span style=color:#f92672>*</span><span style=color:#a6e22e>array</span>.<span style=color:#a6e22e>Int64Builder</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Reserve</span>(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>AppendNull</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>AppendValues</span>([]<span style=color:#66d9ef>int64</span>{<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>}, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>7</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>AppendNull</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>arr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>NewArray</span>().(<span style=color:#f92672>*</span><span style=color:#a6e22e>array</span>.<span style=color:#a6e22e>FixedSizeList</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>arr</span>.<span style=color:#a6e22e>Release</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;NullN()   = %d\n&#34;</span>, <span style=color:#a6e22e>arr</span>.<span style=color:#a6e22e>NullN</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Len()     = %d\n&#34;</span>, <span style=color:#a6e22e>arr</span>.<span style=color:#a6e22e>Len</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Type()    = %v\n&#34;</span>, <span style=color:#a6e22e>arr</span>.<span style=color:#a6e22e>DataType</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;List      = %v\n&#34;</span>, <span style=color:#a6e22e>arr</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></section><div class=post-tags></div></article></main><footer><div style=display:flex></div><div class=footer-info>2023 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>