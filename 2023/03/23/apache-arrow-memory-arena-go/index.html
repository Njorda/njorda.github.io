<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Go memory arenas for apache arrow, Part 1 - Njord tech blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This blog post will try to dive down in to apache arrow and specifically the Go memory allocation for Apache arrow. Apache arrow state that they allow for the following types of memory allocations:
Go default allocations(standard go GC collected memory) CGo allocator(memory allocated through CG0) Checked Memory Allocator Will deep dive in to these once in a follow up blog post. Today the goal is to extend with a new memory allocator, mostly becuase I read up on go memory arena which where introduced in to 1."><meta property="og:image" content><meta property="og:title" content="Go memory arenas for apache arrow, Part 1"><meta property="og:description" content="This blog post will try to dive down in to apache arrow and specifically the Go memory allocation for Apache arrow. Apache arrow state that they allow for the following types of memory allocations:
Go default allocations(standard go GC collected memory) CGo allocator(memory allocated through CG0) Checked Memory Allocator Will deep dive in to these once in a follow up blog post. Today the goal is to extend with a new memory allocator, mostly becuase I read up on go memory arena which where introduced in to 1."><meta property="og:type" content="article"><meta property="og:url" content="https://www.njordy.com/2023/03/23/apache-arrow-memory-arena-go/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-29T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-29T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go memory arenas for apache arrow, Part 1"><meta name=twitter:description content="This blog post will try to dive down in to apache arrow and specifically the Go memory allocation for Apache arrow. Apache arrow state that they allow for the following types of memory allocations:
Go default allocations(standard go GC collected memory) CGo allocator(memory allocated through CG0) Checked Memory Allocator Will deep dive in to these once in a follow up blog post. Today the goal is to extend with a new memory allocator, mostly becuase I read up on go memory arena which where introduced in to 1."><link href=https://www.njordy.com/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.njordy.com/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css></head><body><div class=content><header><div class=main><a href=https://www.njordy.com/>Njord tech blog</a></div><nav><a href=../../../../>Home</a>
<a href=../../../../posts>All posts</a>
<a href=../../../../about>About</a></nav></header><main><article><div class=title><h1 class=title>Go memory arenas for apache arrow, Part 1</h1><div class=meta>Posted on Mar 29, 2023</div></div><section class=body><p>This blog post will try to dive down in to <a href=https://arrow.apache.org/>apache arrow</a> and specifically the <a href=https://github.com/apache/arrow/tree/main/go>Go memory</a> allocation for Apache arrow. Apache arrow state that they allow for the following types of memory allocations:</p><ul><li>Go default allocations(standard go GC collected memory)</li><li>CGo allocator(memory allocated through CG0)</li><li>Checked Memory Allocator</li></ul><p>Will deep dive in to these once in a follow up blog post. Today the goal is to extend with a new memory allocator, mostly becuase I read up on go memory <a href=https://go.dev/src/arena/arena.go>arena</a> which where introduced in to 1.20 under the experimental flag( to access it you need to run go 1.20 or later and have <code>export GOEXPERIMENT=arenas</code>).</p><p>The first question could be why do we do this? Mostly just due to the fact that memory arenas are a interesting concept for Go and I want to play around with it. However I would also like to see if it could give some performance benefits reducing the amount of GC and allocations. But mostly it is just to try it out and have fun.</p><h1 id=what-is-memory-arenas>What is Memory <code>arenas</code>?</h1><blockquote><p>The arena package provides the ability to allocate memory for a collection
of Go values and free that space manually all at once, safely. The purpose
of this functionality is to improve efficiency: manually freeing memory
before a garbage collection delays that cycle. Less frequent cycles means
the CPU cost of the garbage collector is incurred less frequently.</p></blockquote><p>In short it allows for allocating a chunk of memory and then utalise that chunk to store objects. The chunk will not be garbage collected but needs to be freed by the user. Referencing variables that lives in the memory arena after the arena has been freed will result in a panic, and thus care needs to be handled by the users. This also seems to be one of the<a href=https://github.com/golang/go/issues/51317>major concern</a> from the go community about this feature.</p><p>There is also a short blog post <a href=https://www.njordy.com/2023/03/01/go_memory_arena/>Go memory arena</a> specifically about memory arenas.</p><h1 id=update-apache-arrow>Update apache arrow.</h1><p>So the first step is to fork the <a href=https://github.com/apache/arrow>apache arrow repo</a> my fork live <a href=https://github.com/NikeNano/arrow>here</a>, currently the changes are in the <code>nikenano/MemoryArena</code> branch with the changes updates inside <a href=https://github.com/NikeNano/arrow/blob/nikenano/MemoryArena/go/arrow/memory/go_allocator_memory_arena.go>arrow/go/arrow/memory
/go_allocator_memory_arena.go</a>. The implementation is very similar to the Go default implementation(please let me know if you find any errors, most of this is new and I try to learn on the fly).</p><h1 id=test-it-out>Test it out</h1><p>Based upon this example from <a href=https://voltrondata.com/resources/use-apache-arrow-and-go-for-your-data-workflows>Voltron data</a> we will try out our new allocator and see if we can dive down in to the memory profiling in go. We will take the first blog post and replace the memory allocator.</p><p>First step is to reproduce the examples from the blog.</p><p>according to the instructions the first step is to import the following package</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go get -u github.com/apache/arrow/go/v11@latest
</span></span></code></pre></div><p>and the code is the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>examples_test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/apache/arrow/go/v10/arrow&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/apache/arrow/go/v10/arrow/array&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/apache/arrow/go/v10/arrow/memory&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Example_buildInt64</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bldr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>array</span>.<span style=color:#a6e22e>NewInt64Builder</span>(<span style=color:#a6e22e>memory</span>.<span style=color:#a6e22e>DefaultAllocator</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>bldr</span>.<span style=color:#a6e22e>Release</span>() <span style=color:#75715e>// &lt;-- Notice This!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bldr</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>25</span>) <span style=color:#75715e>// append single value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>bldr</span>.<span style=color:#a6e22e>AppendNull</span>() <span style=color:#75715e>// append a null value to the array
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Append a slice of values with a slice of booleans
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// defining which ones are valid or not.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>bldr</span>.<span style=color:#a6e22e>AppendValues</span>([]<span style=color:#66d9ef>int64</span>{<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>}, []<span style=color:#66d9ef>bool</span>{<span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>})
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Or pass nil to assume all are valid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>bldr</span>.<span style=color:#a6e22e>AppendValues</span>([]<span style=color:#66d9ef>int64</span>{<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>}, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>arr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bldr</span>.<span style=color:#a6e22e>NewInt64Array</span>() <span style=color:#75715e>// can be reused after this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>arr</span>.<span style=color:#a6e22e>Release</span>() <span style=color:#75715e>// &lt;-- Notice!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>arr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bldr</span>.<span style=color:#a6e22e>Append</span>([]<span style=color:#66d9ef>int64</span>{<span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>10</span>}, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// get Array interface rather than typed pointer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>arr2</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bldr</span>.<span style=color:#a6e22e>NewArray</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>arr2</span>.<span style=color:#a6e22e>Release</span>() <span style=color:#75715e>// &lt;-- Seeing the pattern?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>arr2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Output:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// [25 (null) 1 (null) 3 4 5 6]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// [7 8 9 10]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>However this gave me the following issue:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go run main.go
</span></span><span style=display:flex><span>../../../../../go/pkg/mod/github.com/apache/arrow/go/v11@v11.0.0/parquet/internal/gen-go/parquet/parquet-consts.go:10:2: missing go.sum entry <span style=color:#66d9ef>for</span> module providing package github.com/apache/thrift/lib/go/thrift <span style=color:#f92672>(</span>imported by github.com/apache/arrow/go/v11/parquet/internal/gen-go/parquet<span style=color:#f92672>)</span>; to add:
</span></span><span style=display:flex><span>	go get github.com/apache/arrow/go/v11/parquet/internal/gen-go/parquet@v11.0.0
</span></span><span style=display:flex><span>../../../../../go/pkg/mod/github.com/apache/arrow/go/v11@v11.0.0/arrow/array/binary.go:26:2: missing go.sum entry <span style=color:#66d9ef>for</span> module providing package github.com/goccy/go-json <span style=color:#f92672>(</span>imported by github.com/apache/arrow/go/v11/arrow/array<span style=color:#f92672>)</span>; to add:
</span></span><span style=display:flex><span>	go get github.com/apache/arrow/go/v11/arrow/array@v11.0.0
</span></span><span style=display:flex><span>../../../../../go/pkg/mod/github.com/apache/arrow/go/v11@v11.0.0/parquet/compress/snappy.go:23:2: missing go.sum entry <span style=color:#66d9ef>for</span> module providing package github.com/golang/snappy <span style=color:#f92672>(</span>imported by github.com/apache/arrow/go/v11/parquet/compress<span style=color:#f92672>)</span>; to add:
</span></span><span style=display:flex><span>	go get github.com/apache/arrow/go/v11/parquet/compress@v11.0.0
</span></span><span style=display:flex><span>../../../../../go/pkg/mod/github.com/apache/arrow/go/v11@v11.0.0/arrow/internal/flatbuf/Binary.go:22:2: missing go.sum entry <span style=color:#66d9ef>for</span> module providing package github.com/google/flatbuffers/go <span style=color:#f92672>(</span>imported by github.com/apache/arrow/go/v11/arrow/internal/flatbuf<span style=color:#f92672>)</span>; to add:
</span></span><span style=display:flex><span>	go get github.com/apache/arrow/go/v11/arrow/internal/flatbuf@v11.0.0
</span></span><span style=display:flex><span>../../../../../go/pkg/mod/github.com/apache/arrow/go/v11@v11.0.0/internal/hashing/xxh3_memo_table.go:31:2: missing go.sum entry <span style=color:#66d9ef>for</span> module providing package github.com/zeebo/xxh3 <span style=color:#f92672>(</span>imported by github.com/apache/arrow/go/v11/internal/hashing<span style=color:#f92672>)</span>; to add:
</span></span><span style=display:flex><span>	go get github.com/apache/arrow/go/v11/internal/hashing@v11.0.0
</span></span><span style=display:flex><span>../../../../../go/pkg/mod/github.com/apache/arrow/go/v11@v11.0.0/arrow/datatype_fixedwidth.go:25:2: missing go.sum entry <span style=color:#66d9ef>for</span> module providing package golang.org/x/xerrors <span style=color:#f92672>(</span>imported by github.com/apache/arrow/go/v11/arrow<span style=color:#f92672>)</span>; to add:
</span></span><span style=display:flex><span>	go get github.com/apache/arrow/go/v11/arrow@v11.0.0
</span></span></code></pre></div><p>this is due to the mix between the v10 and v11 reference in the go package. To solved this update the imports to <code>"github.com/apache/arrow/go/v11/PACKAGE_OF_INTEREST"</code> =></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/apache/arrow/go/v11/arrow&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/apache/arrow/go/v11/arrow/array&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/apache/arrow/go/v11/arrow/memory&#34;</span>
</span></span></code></pre></div><p>This make the code partialy run but we hit the next issue:</p><pre tabindex=0><code>$ go run main.go
# command-line-arguments
./main.go:26:36: too many arguments in call to bldr.Append
	have ([]int64, nil)
	want (int64)
</code></pre><p>The issue is probably due to that that <code>bldr.Append([]int64{7, 8, 9, 10}, nil)</code> should be <code>bldr.AppendValues([]int64{7, 8, 9, 10}, nil)</code></p><h1 id=go-memory-arena>Go memory arena</h1><p>The implementation for using memory arenas lives <a href=https://github.com/NikeNano/arrow/blob/nikenano/MemoryArena/go/arrow/memory/go_allocator_memory_arena.go>here</a>. Where the key is to generate a memory arena which is used to allocate all the memory and only free the arena when we want to free all the memory. There is no way to partly free memory from a memory arena.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>memory</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;arena&#34;</span> <span style=color:#75715e>// requires export GOEXPERIMENT=arenas to be set
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>GoArenaAllocator</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mem</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>arena</span>.<span style=color:#a6e22e>Arena</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Keep track on all the allocations, when all use then we can call free.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// map with the allocations which we need, I think this would be awesome.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>addrs</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int</span>]<span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewGoArenaAllocator</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>GoArenaAllocator</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>GoArenaAllocator</span>{<span style=color:#a6e22e>arena</span>.<span style=color:#a6e22e>NewArena</span>(), <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int</span>]<span style=color:#66d9ef>bool</span>{}, <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>{}}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GoArenaAllocator</span>) <span style=color:#a6e22e>Allocate</span>(<span style=color:#a6e22e>size</span> <span style=color:#66d9ef>int</span>) []<span style=color:#66d9ef>byte</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>arena</span>.<span style=color:#a6e22e>MakeSlice</span>[<span style=color:#66d9ef>byte</span>](<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>mem</span>, <span style=color:#a6e22e>size</span><span style=color:#f92672>+</span><span style=color:#a6e22e>alignment</span>, <span style=color:#a6e22e>size</span><span style=color:#f92672>+</span><span style=color:#a6e22e>alignment</span>) <span style=color:#75715e>// padding for 64-byte alignment, I dont think this is needed in the arena since we make all 64 bit aligned
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>addressOf</span>(<span style=color:#a6e22e>buf</span>))
</span></span><span style=display:flex><span>	<span style=color:#75715e>// So data will be loaded based upon division with 64, here we check the address pointer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// If the data is even division with 64 we can load it to the cache way more efficient and gain speed ups
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// What we do here is move ths buffer around so the address is has a start that is even with 64 so we can load it faster.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>next</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>roundUpToMultipleOf64</span>(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>addr</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>next</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>shift</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>next</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>addr</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>shift</span> : <span style=color:#a6e22e>size</span><span style=color:#f92672>+</span><span style=color:#a6e22e>shift</span> : <span style=color:#a6e22e>size</span><span style=color:#f92672>+</span><span style=color:#a6e22e>shift</span>]
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>addressOf</span>(<span style=color:#a6e22e>out</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>addrs</span>[<span style=color:#a6e22e>addr</span>] = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>out</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>addrs</span>[<span style=color:#a6e22e>addr</span>] = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>buf</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GoArenaAllocator</span>) <span style=color:#a6e22e>CheckSize</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>addrs</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GoArenaAllocator</span>) <span style=color:#a6e22e>Reallocate</span>(<span style=color:#a6e22e>size</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>b</span> []<span style=color:#66d9ef>byte</span>) []<span style=color:#66d9ef>byte</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>==</span> len(<span style=color:#a6e22e>b</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newBuf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Allocate</span>(<span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>	copy(<span style=color:#a6e22e>newBuf</span>, <span style=color:#a6e22e>b</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newBuf</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GoArenaAllocator</span>) <span style=color:#a6e22e>Free</span>(<span style=color:#a6e22e>b</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>addressOf</span>(<span style=color:#a6e22e>b</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	delete(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>addrs</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>addrs</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>Free</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>a couple of tests are also added.</p><h1 id=check-memory-profiles>Check memory profiles</h1><p>In order to check the memory usage we add the following to the example above, we also add a loop and break it out to a function in order for the profile to have time to profile it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pprof</span>.<span style=color:#a6e22e>StartCPUProfile</span>(<span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>pprof</span>.<span style=color:#a6e22e>StopCPUProfile</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>mem</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>MemStats</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;memory baseline...&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>ReadMemStats</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mem</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>Alloc</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>TotalAlloc</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>HeapAlloc</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>HeapSys</span>)
</span></span></code></pre></div><p>Which gives the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;runtime&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;runtime/pprof&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/apache/arrow/go/v11/arrow&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/apache/arrow/go/v11/arrow/array&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/apache/arrow/go/v11/arrow/memory&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#e6db74>&#34;profile.prof&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pprof</span>.<span style=color:#a6e22e>StartCPUProfile</span>(<span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>pprof</span>.<span style=color:#a6e22e>StopCPUProfile</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>mem</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>MemStats</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;memory baseline...&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>ReadMemStats</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mem</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>Alloc</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>TotalAlloc</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>HeapAlloc</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>HeapSys</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>alloc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>memory</span>.<span style=color:#a6e22e>NewGoAllocator</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>1000000</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>run</span>(<span style=color:#a6e22e>alloc</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>now</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>ReadMemStats</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mem</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>Alloc</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>TotalAlloc</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>HeapAlloc</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>HeapSys</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>run</span>(<span style=color:#a6e22e>alloc</span> <span style=color:#a6e22e>memory</span>.<span style=color:#a6e22e>Allocator</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lb</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>array</span>.<span style=color:#a6e22e>NewFixedSizeListBuilder</span>(<span style=color:#a6e22e>alloc</span>, <span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>arrow</span>.<span style=color:#a6e22e>PrimitiveTypes</span>.<span style=color:#a6e22e>Int64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Release</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>ValueBuilder</span>().(<span style=color:#f92672>*</span><span style=color:#a6e22e>array</span>.<span style=color:#a6e22e>Int64Builder</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Reserve</span>(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>AppendNull</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>AppendValues</span>([]<span style=color:#66d9ef>int64</span>{<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>}, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>7</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vb</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>AppendNull</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>arr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>NewArray</span>().(<span style=color:#f92672>*</span><span style=color:#a6e22e>array</span>.<span style=color:#a6e22e>FixedSizeList</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>arr</span>.<span style=color:#a6e22e>Release</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Output:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// [25 (null) 1 (null) 3 4 5 6]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// [7 8 9 10]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Looking at the heap allocations the memory arena is surprisingly high and something seems to be wrong. However this is for a second blog post.</p></section><div class=post-tags></div></article></main><footer><div style=display:flex></div><div class=footer-info>2024 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>